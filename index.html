<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>SIBE Plan</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#141b2a;
      --panel-2:#1c2536;
      --ink:#f8fafc;
      --muted:#9aa4b2;
      --accent:#22c55e;
      --accent-ink:#03110a;
      --danger:#f97316;
      --line:#2b3548;
      --focus:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:var(--bg);
      touch-action:manipulation;
    }
    main{
      display:grid;
      grid-template-columns:240px 1fr;
      gap:12px;
      padding:12px;
      align-items:start;
    }
    @media(max-width:980px){ main{grid-template-columns:1fr} }
    @media(pointer:coarse){
      body{font-size:16px}
      .btn{min-height:46px}
      input[type="text"]{min-height:46px;font-size:16px}
      .symbol-btn{min-height:48px}
      .canvas-toolbar{gap:10px}
      #overlay{touch-action:none}
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
    }
    .panel h2{font-size:14px;margin:0 0 8px 0;}
    .sidebar{
      position:sticky;
      top:12px;
      max-height:calc(100vh - 24px);
      overflow:auto;
    }
    .stack{display:flex;flex-direction:column;gap:8px}
    label{font-size:12px;color:var(--muted)}
    input[type="file"],input[type="text"],button,input[type="range"]{font:inherit;}
    input[type="text"]{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:var(--panel-2);
      color:var(--ink);
    }
    .btn{
      background:var(--accent);
      color:var(--accent-ink);
      border:0;
      padding:8px 10px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
    }
    .btn.secondary{
      background:transparent;
      border:1px solid var(--accent);
      color:var(--ink);
    }
    .btn.danger{background:var(--danger);color:#fff;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}

    .tool-grid{display:grid;grid-template-columns:1fr;gap:6px;}
    .symbol-btn{
      border:1px solid var(--line);
      background:var(--panel-2);
      padding:6px 8px;
      border-radius:10px;
      color:var(--ink);
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      min-height:40px;
      text-align:left;
    }
    .symbol-btn.active{
      border-color:var(--focus);
      box-shadow:0 0 0 2px #1d4ed8;
    }
    .symbol-btn svg{width:22px;height:22px;flex:0 0 auto;}

    .canvas-wrap{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px;
      min-height:70vh;
      position:relative;
    }
    .canvas-toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:8px;
      align-items:center;
    }
    .canvas-area{
      position:relative;
      background:#0a0f1d;
      border-radius:10px;
      overflow:auto;
      border:1px dashed #24324a;
      min-height:60vh;
      touch-action:pan-x pan-y;
    }
    #pdfCanvas{display:block;margin:0 auto;background:#111827;}
    #overlay{position:absolute;inset:0;pointer-events:auto;}

    .empty-state{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      text-align:center; color:#cbd5f5; padding:24px;
      pointer-events:none;
      background:linear-gradient(180deg,rgba(10,15,29,.6),rgba(10,15,29,.85));
    }
    .empty-state strong{display:block;font-size:16px;margin-bottom:6px;color:#f8fafc;}
    .empty-state span{display:block;font-size:13px;color:var(--muted);}

    .overlay-item{
      position:absolute;
      pointer-events:auto;
      cursor:grab;
      transform-origin:center;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .overlay-item.selected{outline:2px solid var(--focus);border-radius:6px;}
    .overlay-item.dragging{cursor:grabbing;outline:2px dashed #93c5fd;border-radius:6px;}
    .overlay-item svg{width:100%;height:100%;}

    .status{font-size:12px;color:var(--muted);}
    .legend{font-size:12px;color:var(--muted);line-height:1.4;}
    kbd{
      background:#0f172a;border:1px solid #334155;border-radius:6px;
      padding:1px 6px;font-size:12px;color:#e2e8f0;
    }
    .mini{font-size:11px;color:var(--muted);line-height:1.35;}
  </style>

  <!-- PDF.js nur für PDF (Bilder funktionieren offline). -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
</head>

<body>
  <main>
    <section class="panel sidebar">
      <h2>Plan laden</h2>
      <div class="stack">
        <label for="fileInput">Plan hochladen (PDF/JPG/PNG)</label>
        <input id="fileInput" type="file" accept="application/pdf,image/jpeg,image/png,image/webp" />

        <label for="projectName">Projektname</label>
        <input id="projectName" type="text" placeholder="z. B. Werkhalle Nord" />

        <div class="status" id="projectStatus">Kein Plan geladen.</div>

        <button class="btn secondary" id="btnSaveProject">Projekt speichern (.json)</button>
        <button class="btn secondary" id="btnLoadProject">Projekt laden (.json)</button>
        <input id="projectFileInput" type="file" accept="application/json" style="display:none" />

        <div class="mini">
          Hinweis: Die PDF/JPG-Datei selbst wird nicht in der Projektdatei gespeichert. Beim Projekt-Laden bitte die passende
          PDF/JPG erneut auswählen – Symbole/Beschriftungen bleiben erhalten.
        </div>
      </div>

      <hr style="border-color:var(--line);margin:12px 0" />

      <h2>Werkzeug</h2>
      <div class="stack" style="margin-bottom:10px">
        <button class="btn secondary" id="btnToolNone">✋ Auswahl aus / Maus</button>
        <div class="status" id="toolStatus">Werkzeug: keines</div>
        <div class="mini">Tipp: <kbd>Esc</kbd> = Werkzeug aus. Klick auf aktives Symbol = abwählen.</div>
      </div>

      <h2>Symbole</h2>
      <div class="tool-grid" id="symbolGrid"></div>

      <div class="stack" style="margin-top:10px">
        <label for="symbolSize">Symbolgröße</label>
        <input id="symbolSize" type="range" min="10" max="48" value="20" />

        <label for="symbolRotate">Rotation</label>
        <input id="symbolRotate" type="range" min="0" max="360" value="0" />

        <hr style="border-color:var(--line);margin:10px 0" />

        <label for="symbolCircuit">Stromkreis (unter Symbol)</label>
        <input id="symbolCircuit" type="text" placeholder="z. B. A1 / SK-03" />

        <label for="symbolNote">Beschriftung (nur bei Auswahl sichtbar)</label>
        <input id="symbolNote" type="text" placeholder="z. B. über Tor 2" />

        <button class="btn secondary" id="btnDelete" disabled>Auswahl löschen</button>
        <div class="mini">Backspace/Delete in den Feldern löscht nur Text – nicht das Symbol.</div>
      </div>

      <hr style="border-color:var(--line);margin:12px 0" />

      <h2>Hinweise</h2>
      <p class="legend">
        1. Plan laden (PDF oder Bild).<br />
        2. Symbol auswählen → im Plan klicken = platzieren.<br />
        3. Danach wird Werkzeug automatisch deaktiviert (kein Versehen).<br />
        4. Symbol anklicken → links bearbeiten / ziehen zum Verschieben.<br />
        5. PNG-Export bleibt korrekt, auch bei Zoom.<br />
      </p>
    </section>

    <section class="panel canvas-wrap">
      <div class="canvas-toolbar">
        <button class="btn" id="btnPrev">← Seite</button>
        <div class="status" id="pageStatus">Seite 0 / 0</div>
        <button class="btn" id="btnNext">Seite →</button>

        <label style="display:flex;align-items:center;gap:6px">
          Zoom
          <input id="zoomRange" type="range" min="50" max="200" value="100" />
        </label>

        <button class="btn secondary" id="btnResetView">Ansicht zurücksetzen</button>
        <button class="btn secondary" id="btnExport" disabled>PNG exportieren</button>
      </div>

      <div class="canvas-area" id="canvasArea">
        <canvas id="pdfCanvas"></canvas>
        <div id="overlay"></div>

        <div class="empty-state" id="emptyState">
          <div>
            <strong>Kein Plan geladen</strong>
            <span>Bitte links eine PDF oder ein Bild auswählen.</span>
            <span class="mini">Wenn PDF schwarz bleibt: Internetzugang prüfen (pdf.js CDN).</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== DOM =====
    const fileInput = document.getElementById("fileInput");
    const projectName = document.getElementById("projectName");
    const projectStatus = document.getElementById("projectStatus");
    const pageStatus = document.getElementById("pageStatus");
    const pdfCanvas = document.getElementById("pdfCanvas");
    const overlay = document.getElementById("overlay");
    const emptyState = document.getElementById("emptyState");

    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const zoomRange = document.getElementById("zoomRange");
    const btnResetView = document.getElementById("btnResetView");
    const btnExport = document.getElementById("btnExport");

    const symbolGrid = document.getElementById("symbolGrid");
    const symbolSize = document.getElementById("symbolSize");
    const symbolRotate = document.getElementById("symbolRotate");
    const symbolCircuit = document.getElementById("symbolCircuit");
    const symbolNote = document.getElementById("symbolNote");
    const btnDelete = document.getElementById("btnDelete");

    const btnToolNone = document.getElementById("btnToolNone");
    const toolStatus = document.getElementById("toolStatus");

    const btnSaveProject = document.getElementById("btnSaveProject");
    const btnLoadProject = document.getElementById("btnLoadProject");
    const projectFileInput = document.getElementById("projectFileInput");

    // ===== State =====
    const STORAGE_KEY = "sibe_planner_state_v8";
    const state = {
      bgType: null,         // "pdf" | "image"
      bgName: "",
      bgLastModified: 0,

      pageNum: 1,
      pageCount: 0,
      scale: 1,

      pdfData: null,
      pdfDoc: null,

      imageUrl: null,
      imageEl: null,
      imageNaturalW: 0,
      imageNaturalH: 0,

      activeSymbol: null,
      selectedId: null,
      symbols: [],

      projectName: "",
      pdfjsReady: false,
    };

    // ===== Symbols =====
    const symbolDefs = [
      // Rettungszeichen
      { id: "exit-left", label: "Rettungszeichen links",
        svg: `<svg viewBox="0 0 64 64" fill="none"><rect width="64" height="64" rx="6" fill="#1aa04a"/><path d="M36 16h10v32H36v-8h6V24h-6v-8Z" fill="#fff"/><path d="M26 26c1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3 1.3 3 3 3Z" fill="#fff"/><path d="M20 42l4-10 6 4 4 8-4 2-3-6-2 4h-5Z" fill="#fff"/><path d="M12 32h18" stroke="#fff" stroke-width="4" stroke-linecap="round"/><path d="M16 26l-8 6 8 6" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>` },
      { id: "exit-right", label: "Rettungszeichen rechts",
        svg: `<svg viewBox="0 0 64 64" fill="none"><rect width="64" height="64" rx="6" fill="#1aa04a"/><path d="M28 16H18v32h10v-8h-6V24h6v-8Z" fill="#fff"/><path d="M38 26c-1.7 0-3-1.3-3-3s1.3-3 3-3 3 1.3 3 3-1.3 3-3 3Z" fill="#fff"/><path d="M44 42l-4-10-6 4-4 8 4 2 3-6 2 4h5Z" fill="#fff"/><path d="M52 32H34" stroke="#fff" stroke-width="4" stroke-linecap="round"/><path d="M48 26l8 6-8 6" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>` },
      { id: "exit-up", label: "Rettungszeichen oben",
        svg: `<svg viewBox="0 0 64 64" fill="none"><rect width="64" height="64" rx="6" fill="#1aa04a"/><path d="M16 40h32v10H16V40Z" fill="#fff"/><path d="M32 24c1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3 1.3 3 3 3Z" fill="#fff"/><path d="M24 34l4-6 8 6 4 8-5 2-3-8-3 4h-5Z" fill="#fff"/><path d="M32 12v18" stroke="#fff" stroke-width="4" stroke-linecap="round"/><path d="M26 16l6-8 6 8" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>` },
      { id: "exit-down", label: "Rettungszeichen unten",
        svg: `<svg viewBox="0 0 64 64" fill="none"><rect width="64" height="64" rx="6" fill="#1aa04a"/><path d="M16 14h32v10H16V14Z" fill="#fff"/><path d="M32 40c1.7 0 3 1.3 3 3s-1.3 3-3 3-3-1.3-3-3 1.3-3 3-3Z" fill="#fff"/><path d="M24 30l4 6 8-6 4-8-5-2-3 8-3-4h-5Z" fill="#fff"/><path d="M32 52V34" stroke="#fff" stroke-width="4" stroke-linecap="round"/><path d="M26 48l6 8 6-8" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>` },
      { id: "exit-straight", label: "Rettungszeichen geradeaus",
        svg: `<svg viewBox="0 0 64 64" fill="none"><rect width="64" height="64" rx="6" fill="#1aa04a"/><path d="M16 42V32h8v6h16v-6h8v10H16Z" fill="#fff"/><path d="M32 20c1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3 1.3 3 3 3Z" fill="#fff"/><path d="M24 30l4-6 8 6 4 10-5 2-3-8-3 4h-5Z" fill="#fff"/><path d="M32 12v18" stroke="#fff" stroke-width="4" stroke-linecap="round"/><path d="M26 16l6-8 6 8" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>` },

      // Leuchten
      { id: "lamp", label: "Notleuchte",
        svg: `<svg viewBox="0 0 64 64" fill="none"><rect width="64" height="64" rx="6" fill="#0ea5e9"/><rect x="14" y="20" width="36" height="18" rx="4" fill="#fff"/><path d="M22 42h20l-2 6H24l-2-6Z" fill="#fff"/><path d="M32 10v6" stroke="#fff" stroke-width="4" stroke-linecap="round"/><path d="M20 14l4 4" stroke="#fff" stroke-width="4" stroke-linecap="round"/><path d="M44 14l-4 4" stroke="#fff" stroke-width="4" stroke-linecap="round"/></svg>` },
      { id: "lamp-emergency", label: "Sicherheitsleuchte",
        svg: `<svg viewBox="0 0 64 64" fill="none"><rect width="64" height="64" rx="6" fill="#f59e0b"/><path d="M16 32c0-8.8 7.2-16 16-16s16 7.2 16 16c0 6.3-3.7 11.8-9 14.3V50H25v-5.7c-5.3-2.5-9-8-9-14.3Z" fill="#fff"/><rect x="24" y="50" width="16" height="6" rx="2" fill="#fff"/></svg>` },

      // Elektro
      { id: "junction-box", label: "Abzweigdose",
        svg: `<svg viewBox="0 0 64 64" fill="none">
          <rect width="64" height="64" rx="6" fill="#64748b"/>
          <rect x="16" y="16" width="32" height="32" rx="6" fill="#0f172a" stroke="#ffffff" stroke-width="3"/>
          <circle cx="32" cy="32" r="4" fill="#ffffff"/>
          <path d="M32 22v20M22 32h20" stroke="#ffffff" stroke-width="3" stroke-linecap="round"/>
        </svg>` },

      // Feuerlöscher
      { id: "fire-extinguisher", label: "Feuerlöscher",
        svg: `<svg viewBox="0 0 64 64" fill="none">
          <rect width="64" height="64" rx="6" fill="#ef4444"/>
          <path d="M26 18c0-2.5 2-4.5 4.5-4.5h3c2.5 0 4.5 2 4.5 4.5v5H26v-5Z" fill="#fff"/>
          <rect x="24" y="23" width="16" height="29" rx="6" fill="#fff"/>
          <path d="M40 24h8c1.5 0 2.5 1 2.5 2.5S49.5 29 48 29h-6" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
          <path d="M41 21l6-3" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
          <path d="M29 33h6" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/>
          <path d="M32 36c-2.5 2-3.5 4.5-3.5 7.5" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/>
        </svg>` },
    ];

    // ===== Helpers =====
    function isTypingInField() {
      const el = document.activeElement;
      if (!el) return false;
      const tag = (el.tagName || "").toLowerCase();
      return tag === "input" || tag === "textarea" || tag === "select" || el.isContentEditable === true;
    }

    function saveState() {
      const data = {
        bgName: state.bgName,
        bgLastModified: state.bgLastModified,
        bgType: state.bgType,
        pageNum: state.pageNum,
        scale: state.scale,
        symbols: state.symbols,
        activeSymbol: state.activeSymbol,
        selectedId: state.selectedId,
        projectName: state.projectName,
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        state.bgName = data.bgName || "";
        state.bgLastModified = data.bgLastModified || 0;
        state.bgType = data.bgType || null;
        state.pageNum = data.pageNum || 1;
        state.scale = typeof data.scale === "number" ? data.scale : 1;
        state.symbols = Array.isArray(data.symbols) ? data.symbols : [];
        state.activeSymbol = data.activeSymbol || null;
        state.selectedId = data.selectedId || null;
        state.projectName = data.projectName || "";
        projectName.value = state.projectName;
      } catch {
        localStorage.removeItem(STORAGE_KEY);
      }
    }

    function setToolNone() {
      state.activeSymbol = null;
      document.querySelectorAll(".symbol-btn").forEach(btn => btn.classList.remove("active"));
      toolStatus.textContent = "Werkzeug: keines";
      saveState();
    }

    // Klick auf aktives Symbol => abwählen
    function setActiveSymbol(id) {
      if (state.activeSymbol === id) {
        setToolNone();
        return;
      }
      state.activeSymbol = id;
      document.querySelectorAll(".symbol-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.symbol === id);
      });
      const def = symbolDefs.find(s => s.id === id);
      toolStatus.textContent = def ? `Werkzeug: ${def.label}` : "Werkzeug: Symbol";
      saveState();
    }

    function renderSymbolButtons() {
      symbolGrid.innerHTML = "";
      symbolDefs.forEach(def => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "symbol-btn";
        btn.dataset.symbol = def.id;
        btn.innerHTML = `${def.svg}<span>${def.label}</span>`;

        // ✅ nur click (kein pointerdown) -> kein Doppel-Toggle
        btn.addEventListener("click", () => setActiveSymbol(def.id));

        btn.setAttribute("draggable", "true");
        btn.addEventListener("dragstart", (event) => {
          event.dataTransfer.setData("text/plain", def.id);
        });

        symbolGrid.appendChild(btn);
      });

      if (state.activeSymbol) setActiveSymbol(state.activeSymbol);
      else setToolNone();
    }

    function updateStatus() {
      const planLoaded = !!state.pageCount;

      if (state.bgType === "pdf" && !state.pdfjsReady) {
        projectStatus.textContent = "PDF.js konnte nicht geladen werden. PDF ggf. nicht sichtbar (Bilder funktionieren).";
      } else {
        projectStatus.textContent = state.bgName ? `Plan: ${state.bgName}` : "Kein Plan geladen.";
      }

      pageStatus.textContent = `Seite ${state.pageNum} / ${state.pageCount}`;
      btnPrev.disabled = state.pageNum <= 1;
      btnNext.disabled = state.pageNum >= state.pageCount;
      btnExport.disabled = !planLoaded;
      emptyState.style.display = planLoaded ? "none" : "flex";
      btnDelete.disabled = !state.selectedId;

      const sel = state.symbols.find(s => s.id === state.selectedId);
      symbolCircuit.disabled = !sel;
      symbolNote.disabled = !sel;
      symbolSize.disabled = !sel;
      symbolRotate.disabled = !sel;
    }

    function selectSymbol(id) {
      state.selectedId = id;
      const item = state.symbols.find(s => s.id === id);
      if (item) {
        symbolSize.value = item.size;
        symbolRotate.value = item.rotation;
        symbolCircuit.value = item.circuit || "";
        symbolNote.value = item.note || "";
      } else {
        symbolCircuit.value = "";
        symbolNote.value = "";
      }
      renderOverlay();
      saveState();
    }

    function clearSelection() {
      state.selectedId = null;
      symbolCircuit.value = "";
      symbolNote.value = "";
      renderOverlay();
      saveState();
    }

    function updateSelectedSymbolSizing() {
      const item = state.symbols.find(s => s.id === state.selectedId);
      if (!item) return;
      item.size = Number(symbolSize.value);
      item.rotation = Number(symbolRotate.value);
      renderOverlay();
      saveState();
    }

    // ===== Overlay render =====
    function enableDrag(element) {
      let startX = 0, startY = 0, originX = 0, originY = 0, dragging = false;

      const onMove = (event) => {
        if (!dragging) return;
        const dx = event.clientX - startX;
        const dy = event.clientY - startY;
        const scale = state.scale;

        const item = state.symbols.find(s => s.id === element.dataset.id);
        if (!item) return;

        item.x = Math.max(0, originX + dx / scale);
        item.y = Math.max(0, originY + dy / scale);

        element.style.left = `${item.x * scale}px`;
        element.style.top = `${item.y * scale}px`;
      };

      const stopMove = () => {
        if (!dragging) return;
        dragging = false;
        element.classList.remove("dragging");
        document.removeEventListener("pointermove", onMove);
        saveState();
        renderOverlay();
      };

      element.addEventListener("pointerdown", (event) => {
        event.preventDefault();
        event.stopPropagation();

        const item = state.symbols.find(s => s.id === element.dataset.id);
        if (!item) return;

        selectSymbol(item.id);

        dragging = true;
        element.classList.add("dragging");
        startX = event.clientX;
        startY = event.clientY;
        originX = item.x;
        originY = item.y;

        element.setPointerCapture(event.pointerId);
        document.addEventListener("pointermove", onMove);
        document.addEventListener("pointerup", stopMove, { once: true });
        document.addEventListener("pointercancel", stopMove, { once: true });
      });
    }

    function renderOverlay() {
      overlay.innerHTML = "";
      const scale = state.scale;
      const items = state.symbols.filter(item => item.page === state.pageNum);

      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "overlay-item";
        if (state.selectedId === item.id) div.classList.add("selected");

        div.style.left = `${item.x * scale}px`;
        div.style.top = `${item.y * scale}px`;
        div.style.width = `${item.size * scale}px`;
        div.style.height = `${item.size * scale}px`;
        div.style.transform = `rotate(${item.rotation}deg)`;

        const def = symbolDefs.find(s => s.id === item.symbol);
        div.innerHTML = def ? def.svg : "";

        // Stromkreis immer sichtbar (✅ Text schwarz)
        const circuitText = (item.circuit ?? "").trim();
        if (circuitText) {
          const cap = document.createElement("div");
          cap.style.position = "absolute";
          cap.style.left = "50%";
          cap.style.top = "100%";
          cap.style.transform = "translate(-50%, 6px)";
          cap.style.fontSize = `${Math.max(10, Math.round(item.size * 0.45))}px`;
          cap.style.color = "#000";
          cap.style.background = "rgba(255,255,255,.88)";
          cap.style.border = "1px solid #111";
          cap.style.padding = "2px 6px";
          cap.style.borderRadius = "6px";
          cap.style.whiteSpace = "nowrap";
          cap.style.pointerEvents = "none";
          cap.textContent = circuitText;
          div.appendChild(cap);
        }

        // Beschriftung nur bei Auswahl sichtbar
        const noteText = (item.note ?? "").trim();
        if (state.selectedId === item.id && noteText) {
          const note = document.createElement("div");
          note.style.position = "absolute";
          note.style.left = "50%";
          note.style.bottom = "100%";
          note.style.transform = "translate(-50%, -8px)";
          note.style.fontSize = "12px";
          note.style.color = "#f8fafc";
          note.style.background = "rgba(2,6,23,.9)";
          note.style.border = "1px solid #475569";
          note.style.padding = "4px 8px";
          note.style.borderRadius = "8px";
          note.style.whiteSpace = "nowrap";
          note.style.pointerEvents = "none";
          note.textContent = noteText;
          div.appendChild(note);
        }

        div.dataset.id = item.id;
        enableDrag(div);

        div.addEventListener("click", (event) => {
          event.stopPropagation();
          selectSymbol(item.id);
        });

        overlay.appendChild(div);
      });

      updateStatus();
    }

    // ===== Rendering background =====
    async function renderPdfPage(pdf, pageNum) {
      const page = await pdf.getPage(pageNum);
      const viewport = page.getViewport({ scale: state.scale });

      pdfCanvas.width = viewport.width;
      pdfCanvas.height = viewport.height;
      overlay.style.width = `${viewport.width}px`;
      overlay.style.height = `${viewport.height}px`;

      const ctx = pdfCanvas.getContext("2d");
      await page.render({ canvasContext: ctx, viewport }).promise;

      renderOverlay();
      updateStatus();
    }

    function renderImage() {
      const img = state.imageEl;
      if (!img) return;

      const w = Math.round(state.imageNaturalW * state.scale);
      const h = Math.round(state.imageNaturalH * state.scale);

      pdfCanvas.width = w;
      pdfCanvas.height = h;
      overlay.style.width = `${w}px`;
      overlay.style.height = `${h}px`;

      const ctx = pdfCanvas.getContext("2d");
      ctx.clearRect(0, 0, w, h);
      ctx.drawImage(img, 0, 0, w, h);

      renderOverlay();
      updateStatus();
    }

    async function loadPdf(data) {
      state.bgType = "pdf";

      if (!window.pdfjsLib) {
        state.pdfjsReady = false;
        state.pageCount = 0;
        updateStatus();
        return;
      }
      state.pdfjsReady = true;

      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

      try {
        const pdf = await pdfjsLib.getDocument({ data }).promise;
        state.pdfDoc = pdf;
        state.pageCount = pdf.numPages;
        state.pageNum = Math.min(Math.max(1, state.pageNum), state.pageCount);
        await renderPdfPage(pdf, state.pageNum);
      } catch {
        projectStatus.textContent = "PDF konnte nicht geladen werden. Datei prüfen.";
      }
    }

    async function loadImageFile(file) {
      if (state.imageUrl) URL.revokeObjectURL(state.imageUrl);

      state.bgType = "image";
      state.pdfDoc = null;
      state.pdfData = null;

      state.pageCount = 1;
      state.pageNum = 1;

      const url = URL.createObjectURL(file);
      state.imageUrl = url;

      const img = new Image();
      img.onload = () => {
        state.imageEl = img;
        state.imageNaturalW = img.naturalWidth || img.width;
        state.imageNaturalH = img.naturalHeight || img.height;
        renderImage();
      };
      img.onerror = () => { projectStatus.textContent = "Bild konnte nicht geladen werden."; };
      img.src = url;
    }

    async function renderCurrent() {
      if (state.bgType === "pdf" && state.pdfDoc) return renderPdfPage(state.pdfDoc, state.pageNum);
      if (state.bgType === "image" && state.imageEl) return renderImage();
      updateStatus();
    }

    // ===== Placement =====
    function placeSymbolAt(clientX, clientY) {
      if (!state.activeSymbol) return;
      if (!state.pageCount) return;

      const rect = overlay.getBoundingClientRect();
      const scale = state.scale;
      const size = Number(symbolSize.value);

      const x = (clientX - rect.left) / scale - size / 2;
      const y = (clientY - rect.top) / scale - size / 2;

      const id = `sym_${Date.now()}_${Math.random().toString(16).slice(2)}`;
      const symbol = {
        id,
        symbol: state.activeSymbol,
        x: Math.max(0, x),
        y: Math.max(0, y),
        size,
        rotation: Number(symbolRotate.value),
        page: state.pageNum,
        circuit: "",
        note: ""
      };

      state.symbols.push(symbol);
      selectSymbol(id);
      saveState();

      // nach Platzieren Werkzeug aus
      setToolNone();
    }

    // ===== Export PNG =====
    function svgToImage(svgMarkup) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svgMarkup)))}`;
      });
    }

    async function exportPNG() {
      if (!state.pageCount) return;

      const exportCanvas = document.createElement("canvas");
      const ctx = exportCanvas.getContext("2d");

      // Hintergrund immer in scale=1 rendern (Zoom-unabhängig)
      if (state.bgType === "pdf" && state.pdfDoc) {
        const page = await state.pdfDoc.getPage(state.pageNum);
        const viewport = page.getViewport({ scale: 1 });
        exportCanvas.width = viewport.width;
        exportCanvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
      } else if (state.bgType === "image" && state.imageEl) {
        exportCanvas.width = state.imageNaturalW;
        exportCanvas.height = state.imageNaturalH;
        ctx.drawImage(state.imageEl, 0, 0);
      } else {
        return;
      }

      const items = state.symbols.filter(s => s.page === state.pageNum);

      for (const item of items) {
        const def = symbolDefs.find(s => s.id === item.symbol);
        if (!def) continue;

        const temp = document.createElement("div");
        temp.innerHTML = def.svg;
        const svg = temp.firstChild;
        const svgData = new XMLSerializer().serializeToString(svg);
        const img = await svgToImage(svgData);

        ctx.save();
        ctx.translate(item.x + item.size / 2, item.y + item.size / 2);
        ctx.rotate((Math.PI / 180) * item.rotation);
        ctx.translate(-item.size / 2, -item.size / 2);
        ctx.drawImage(img, 0, 0, item.size, item.size);
        ctx.restore();

        const circuitText = (item.circuit || "").trim();
        if (circuitText) {
          ctx.save();
          ctx.font = `${Math.max(10, Math.round(item.size * 0.45))}px system-ui,Segoe UI,Roboto,Arial,sans-serif`;
          ctx.fillStyle = "#000000"; // ✅ Text schwarz im Export
          ctx.fillText(circuitText, item.x, item.y + item.size + 16);
          ctx.restore();
        }
      }

      const link = document.createElement("a");
      link.download = `${(state.projectName || "sicherheitsplan")}_seite_${state.pageNum}.png`;
      link.href = exportCanvas.toDataURL("image/png");
      link.click();
    }

    // ===== Projekt speichern/laden (.json) =====
    function downloadTextFile(filename, text) {
      const blob = new Blob([text], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    function exportProjectJSON() {
      const data = {
        version: 1,
        savedAt: new Date().toISOString(),
        projectName: state.projectName || "",
        bgName: state.bgName || "",
        bgType: state.bgType || null,
        bgLastModified: state.bgLastModified || 0,
        pageCount: state.pageCount || 0,
        symbols: state.symbols || [],
      };

      const safeName = (state.projectName || "sibe_projekt")
        .replace(/[^\w\-]+/g, "_")
        .slice(0, 60);

      downloadTextFile(`${safeName}.json`, JSON.stringify(data, null, 2));
    }

    async function importProjectJSON(file) {
      const text = await file.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        alert("Ungültige Projektdatei (JSON fehlerhaft).");
        return;
      }

      if (!data || !Array.isArray(data.symbols)) {
        alert("Ungültige Projektdatei (keine Symbole gefunden).");
        return;
      }

      state.projectName = data.projectName || "";
      projectName.value = state.projectName;

      state.symbols = data.symbols || [];
      state.selectedId = null;

      state.bgName = data.bgName || "";
      state.bgType = data.bgType || null;
      state.bgLastModified = data.bgLastModified || 0;

      // Wichtig: Hintergrund-Datei muss erneut ausgewählt werden (PDF/JPG selbst ist nicht gespeichert)
      setToolNone();
      saveState();
      renderOverlay();
      updateStatus();

      alert(
        "Projekt geladen.\n\nBitte jetzt die passende PDF/JPG erneut auswählen:\n" +
        (state.bgName ? `→ ${state.bgName}` : "→ (Dateiname unbekannt)")
      );
    }

    // ===== Events =====
    fileInput.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      state.bgName = file.name;
      state.bgLastModified = file.lastModified || Date.now();
      state.selectedId = null;

      const type = (file.type || "").toLowerCase();
      if (type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf")) {
        const arrayBuffer = await file.arrayBuffer();
        state.pdfData = new Uint8Array(arrayBuffer);
        await loadPdf(state.pdfData);
        saveState();
        return;
      }
      if (type.startsWith("image/")) {
        await loadImageFile(file);
        saveState();
        return;
      }

      projectStatus.textContent = "Unbekannter Dateityp. Bitte PDF oder Bild wählen.";
    });

    projectName.addEventListener("input", () => {
      state.projectName = projectName.value;
      saveState();
    });

    btnPrev.addEventListener("click", async () => {
      if (state.pageNum <= 1) return;
      state.pageNum -= 1;
      await renderCurrent();
      saveState();
    });

    btnNext.addEventListener("click", async () => {
      if (state.pageNum >= state.pageCount) return;
      state.pageNum += 1;
      await renderCurrent();
      saveState();
    });

    zoomRange.addEventListener("input", async () => {
      state.scale = Number(zoomRange.value) / 100;
      await renderCurrent();
      saveState();
    });

    btnResetView.addEventListener("click", async () => {
      state.scale = 1;
      zoomRange.value = 100;
      await renderCurrent();
      saveState();
    });

    btnExport.addEventListener("click", exportPNG);

    btnDelete.addEventListener("click", () => {
      if (!state.selectedId) return;
      state.symbols = state.symbols.filter(s => s.id !== state.selectedId);
      clearSelection();
      saveState();
      renderOverlay();
    });

    btnToolNone.addEventListener("click", setToolNone);

    overlay.addEventListener("click", (event) => {
      if (state.activeSymbol) {
        placeSymbolAt(event.clientX, event.clientY);
      } else {
        clearSelection();
      }
    });

    overlay.addEventListener("dragover", (event) => event.preventDefault());
    overlay.addEventListener("drop", (event) => {
      event.preventDefault();
      const symbolId = event.dataTransfer.getData("text/plain");
      if (!symbolId) return;
      setActiveSymbol(symbolId);
      placeSymbolAt(event.clientX, event.clientY);
    });

    symbolSize.addEventListener("input", updateSelectedSymbolSizing);
    symbolRotate.addEventListener("input", updateSelectedSymbolSizing);

    symbolCircuit.addEventListener("input", () => {
      const item = state.symbols.find(s => s.id === state.selectedId);
      if (!item) return;
      item.circuit = symbolCircuit.value;
      saveState();
      renderOverlay();
    });

    symbolNote.addEventListener("input", () => {
      const item = state.symbols.find(s => s.id === state.selectedId);
      if (!item) return;
      item.note = symbolNote.value;
      saveState();
      renderOverlay();
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        event.preventDefault();
        setToolNone();
        return;
      }
      if (isTypingInField()) return;
      if (!state.selectedId) return;
      if (event.key === "Delete" || event.key === "Backspace") {
        event.preventDefault();
        btnDelete.click();
      }
    });

    // Projekt speichern/laden UI
    btnSaveProject.addEventListener("click", () => exportProjectJSON());

    btnLoadProject.addEventListener("click", () => {
      projectFileInput.value = "";
      projectFileInput.click();
    });

    projectFileInput.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      await importProjectJSON(file);
    });

    window.addEventListener("beforeunload", saveState);

    // ===== Init =====
    function init() {
      loadState();
      renderSymbolButtons();

      zoomRange.value = Math.round(state.scale * 100);
      state.pdfjsReady = !!window.pdfjsLib;

      updateStatus();
      renderOverlay();

      // pdfjs kann leicht später geladen sein
      setTimeout(() => {
        state.pdfjsReady = !!window.pdfjsLib;
        updateStatus();
      }, 1200);
    }

    init();
  </script>
</body>
</html>
